
@using FluentLang.Compiler.Diagnostics
@inherits LayoutComponentBase
@inject IJSRuntime JsRuntime
@inject IDiagnosticFormatter DiagnosticFormatter

<div class="body">
    <div class="split left">
        <div id="editor" style="position:absolute; height: 100%; width: 100%">Text</div>
    </div>
    <div class="split right">
        <div class="tab">
            <button class=@(CurrentTab == Tab.EmittedCSharp ? "tablinks active" : "tablinks")
                    @onclick=@(() => CurrentTab = Tab.EmittedCSharp)>
                Emitted CSharp
            </button>
            <button class=@(CurrentTab == Tab.Result ? "tablinks active" : "tablinks")
                    @onclick=@(() => CurrentTab = Tab.Result)>
                Result
            </button>
        </div>
        <div id="csharp" class="output flex" hidden=@(CurrentTab != Tab.EmittedCSharp)>
            <header>Emitted CSharp</header>
            <pre class="output" @ref="EmittedCSharpRef" hidden="@(EmittedCSharp is null)">
                <code class="lang-csharp" ></code>
            </pre>
        </div>
        <div id="result" class="output flex" hidden=@(CurrentTab != Tab.Result)>
            <header>Result</header>
            @Result
        </div>
        <div id="diagnostics" class="output diagnostic flex" hidden=@(Diagnostics.IsDefault)>
            <header>Diagnostics</header>
            <ul>
                @if (!Diagnostics.IsDefault)
                {
                    @foreach (var diagnostic in Diagnostics)
                    {
                        <li>@($"ERROR! Location: {DiagnosticFormatter.CreateLocationMessage(diagnostic)}, Message: {DiagnosticFormatter.CreateDiagnosticMessage(diagnostic)}")</li>
                    }
                }
            </ul>
        </div>
        <div id="runtime-error" class="output diagnostic flex" hidden=@(RuntimeError == null)>
            <header>Runtime Error</header>
            @RuntimeError
        </div>
    </div>
</div>

@code {

    Tab CurrentTab = Tab.EmittedCSharp;
    ElementReference EmittedCSharpRef;

    enum Tab
    {
        EmittedCSharp,
        Result,
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JsRuntime.InvokeVoidAsync("initEditor", _thisRef).AsTask();
        }
        if (EmittedCSharp != null)
            await Highlight();
    }

    private ValueTask Highlight()
    {
        return JsRuntime.InvokeVoidAsync("highlight", EmittedCSharpRef, EmittedCSharp);
    }
}
